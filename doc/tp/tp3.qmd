---
title: "Discographie ğŸµ"
description: "TP3"
author: "Ludovic Deneuville"
format: 
  html:
    toc: true
    toc-location: left
    toc-expand: 3
from: markdown+emoji
number-sections: true
number-depth: 3
lightbox: true
---

## Introduction {.unnumbered}

::: {.callout-important}
- Ã‰crivez des requÃªtes jolies !
- Ã€ la fin du TP, exportez ou copiez vos requÃªtes dans un fichier de votre VM ou machine personnelle
:::

Les notions vues dans ce TP :

- agrÃ©gations
- jointures
- insertion de donnÃ©es
- utilisation de sÃ©quence
- bonus : CTE (vu au dernier cours)


## Lancement des services

Pour plus de dÃ©tails, allez dans l'onglet [Datalab](../outils/datalab.qmd){target="_blank"}.

- [ ] Connectez-vous Ã  un Datalab
- [ ] Lancez un service **PostgreSQL**
- [ ] Lancez un service **cloudBeaver**
  - ouvrez ce service
  - vÃ©rifiez que vous Ãªtes connectÃ©s Ã  la base de donnÃ©es PostgreSQL


## Les donnÃ©es

Le thÃ¨me du jour sera la musique :musical_note: :guitar: :trumpet:

### Chargez les donnÃ©es

- [ ] Copiez le contenu de ces 2 scripts sql 
  - [crÃ©ation des tables](./data/tp3-create-tables.sql){target="_blank"} 
  - [insertion des donnÃ©es](./data/tp3-pop-tables.sql){target="_blank"} 
- [ ] Collez-les dans la fenÃªtre SQL de CloudBeaver
- [ ] ExÃ©cutez les scripts
  - Cliquez sur la petite icone sous les triangles oranges qui ressemble Ã  :scroll:
  - raccourci (ALT + X)


### Description

Les tables sont les suivantes :

- **artiste**([id_artiste]{.underline}, nom, code_pays, date_naissance, actif)
- **album**([id_album]{.underline}, titre, annee, #id_artiste)
- **chanson**([id_chanson]{.underline}, #id_artiste_principal, titre, duree, #id_album, annee)
- **playlist**([id_playlist]{.underline}, nom, date_creation, description)
- **playlist_chanson**([#id_playlist, #id_chanson]{.underline}, ordre, date_ajout)


### ModÃ¨le de donnÃ©es


![](./data/tp3-uml.PNG)


## Exercice

### Exploration des tables

Lorsque vous prenez en main une base de donnÃ©es, la premiÃ¨re chose Ã  faire est de regarder ce que contiennent les tables.

- [ ] Listez toutes les chansons
- [ ] Affichez les colonnes *titre* et *annÃ©e* ainsi que le *nom de l'artiste principal*
- [ ] Ordonnez par nom d'artiste, puis par titre
- [ ] Ajoutez le titre de l'album [si celui-ci est prÃ©cisÃ©]{.underline}
- [ ] Ajoutez le nom de l'artiste de l'album
- [ ] Est-ce qu'il y a des chansons oÃ¹ il y a une diffÃ©rence entre :
  - l'artiste principal de la chanson
  - l'artiste de l'album qui contient cette chanson

Faisons quelques statistiques descriptives.

- [ ] Quelle sont les durÃ©es minimum, maximum et moyenne des chansons
- [ ] Affichez le nombre de chansons par annÃ©e
  - ordonnez par nombre de chansons dÃ©croissant
- [ ] Quelles sont les annÃ©es avec au moins 10 chansons
- [ ] ComplÃ©tez la derniÃ¨re requÃªte en ajoutant la durÃ©e moyenne des chansons pour chaque annÃ©e

Est-ce qu'il y a plusieurs chansons ayant le mÃªme titre ?

- [ ] Pour chaque titre de chanson, comptez le nombre d'occurences
- [ ] Est-ce qu'il y a des titres de chansons prÃ©sents au moins deux fois ?
- [ ] Est-ce qu'il y a des chansons en doublon ?
  - i.e. mÃªme titre et mÃªme artiste

Si vous en trouvez une, essayez de la supprimer. Ã€ votre avis, pourquoi cela ne fonctionne pas ?

- [ ] CrÃ©ez une vue *titre_frequent* listant les titres des chansons prÃ©sents au moins deux fois ?
- [ ] Pour ces titres, affichez tous les dÃ©tails des chansons, ainsi que l'artiste principal
  - triez par titre


### Place aux artistes

- [ ] Listez les noms d'artistes ainsi que les titres de leurs chansons
- [ ] Comptez le nombre de chansons par artiste
- [ ] Classez par ordre dÃ©croissant
- [ ] Conservez uniquement les artistes ayant 20 chansons ou plus

Il y a des artistes solo et des groupes. Pour les groupe la date de naissance ne devrait pas Ãªtre renseignÃ©e.

- [ ] Mettez Ã  jour la table pour supprimer les dates de naissance des groupes
  - :scream: si vous avez fait une bÃ©tise, pas de panique, il faut relancer les deux scripts du dÃ©but de TP (create and pop)
- [ ] Quel est le plus viel artiste solo en activitÃ© ?

Interessons nous maintenant aux pays des artistes.

- [ ] Comptez le nombre d'artistes par pays

### CrÃ©ez votre playlist

- [ ] InsÃ©rez une nouvelle ligne dans la table *playlist*
- [ ] Ajoutez 5 chansons dans votre playlist

::: {.callout-tip}
Aucune de ces chansons ne correspond Ã  vos goÃ»t musicaux...

Vous Ãªtes vraiment sÃ»r ?

Allez un petit effort, il y a des chansons et des artistes trÃ¨s sympas.
:::

Nous allons maintenant ajouter Ã  votre playlist toutes les chansons de l'album *Californian Soil*.

Pour crÃ©er votre requÃªte d'insertion, vous allez avoir besoin des donnÃ©es suivantes : 

- *id_playlist* : vous pouvez soit :
  - insÃ©rer la valeur "en dur"
  - utiliser `CURRVAL('playlist_id_playlist_seq')` pour obtenir la derniÃ¨re valeur de *id_playlist* i.e. celui de la playlist que vous venez de crÃ©er
- *id_chanson* : il va falloir une reqÃ»ete pour les rÃ©cupÃ©rer
- *ordre* : vous allez crÃ©er et utiliser une sÃ©quence
- *date_ajout* : vous utiliserez simplement : `CURRENT_DATE`

---

- [ ] CrÃ©ez une sÃ©quence nommÃ©e *seq_playlist_ordre*
  - comme vous avez dÃ©jÃ  insÃ©rÃ© 5 chansons, les valeurs de la colonne ordre de 1 Ã  5 sont normalement dÃ©jÃ  prises
  - commencez votre sÃ©quence Ã  la valeur 6
- [ ] Listez toutes les chansons de l'album *Californian Soil*
- [ ] InsÃ©rer dans votre playlist toutes les chansons de l'album *Californian Soil*

::: {.callout-tip title="Un peu d'aide" collapse="true"}
Pour trouver un peu d'inspiration, un exemple d'INSERT en utilisant un SELECT :

```{.sql}
INSERT INTO joueuse_copy(nom, prenom, numero, date_creation)
SELECT nom,
       'pierre',
       nextval('seq_numero'),
       CURRENT_DATE
  FROM joueuse;
```
:::


Est-ce que vous pouvez ajouter plusieurs fois la mÃªme chanson dans une playlist ? Pourquoi ?

Comment pourrait-t-on faire pour s'affranchir de cette contrainte ?


### Votez pour la meilleure playlist

Interessons-nous maintenant aux playlists.

- [ ] Affichez les playlists
- [ ] Ajoutez les titres des chansons de la playlist
  - Colonnes Ã  afficher : nom de la playlist, ordre, titre de la chanson
  - Classez par noms de playlists, puis ordre
- [ ] Ajoutez les noms des artistes

Vous remarquez qu'Ã  l'affichage vous avez deux colonnes appelÃ©es "nom". Pour faire la diffÃ©rence, vous allez modifier l'affichage de ces colonnes.

- [ ] Modifiez le *SELECT* pour afficher les entÃªtes de colonnes *Nom de la playlist*, *Titre de la chanson* et *Nom de l'artiste*

---

- [ ] Quelle playlist a le plus de chansons ?
- [ ] Quelle playlist dure le plus longtemps ?

Nous allons maintenant rechercher les artistes mal-aimÃ©s i.e. ceux qui ne sont dans aucune playlist. 

ProcÃ©dons par Ã©tape:

- [ ] Listez les artistes prÃ©sents dans les playlists
- [ ] Ensuite, gardez uniquement les *id_artiste* sans doublons
- [ ] Affichez les artistes qui ne sont prÃ©sents dans aucune playlist
  - en utilisant `NOT IN` et une sous-requÃªte
  - conservez uniquement les *id_artiste* qui ne sont pas dans la requÃªte prÃ©cÃ©dente
- [ ] MÃªme question avec `NOT EXISTS`
  - la syntaxe est un peu moins intuitive mais la requÃªte est plus optimisÃ©e

Concentrons-nous maintenant sur les artistes et les chansons les plus populaires.

Vous avez Ã©crit prÃ©cÃ©demment une requÃªte listant les playlists avec les artistes et les chansons. Repartez de cette requÃªte.

- [ ] Comptez combien de fois chaque chanson apparait dans une playlist
  - affichez le titre de la chanson, le nom de l'artiste, et le nombre de playlists
  - ordonnez par nombre de playlists dÃ©croissant
- [ ] Au lieu de faire un simple **JOIN** avec la table *playlist_chanson*, faites un **LEFT JOIN**
  - Est-ce que Â« Tu feras la diffÃ©rence. Ton coeur prend des vacances. Il danse avec les loups. Â» ?
- [ ] Conservez uniquement celles qui apparaissent dans au moins 3 playlists
- [ ] Combien y-a-t-il de chansons dans toutes les playlists
- [ ] Combien y-a-t-il de chansons diffÃ©rentes dans toutes les playlists


### I'm WITH u

Les CTE seront Ã©voquÃ©es au dernier cours. Cela parait compliquÃ© Ã  premiÃ¨re vue mais le principe est trÃ¨s simple.

::: {.callout-note title="CTE"}
Une CTE (Common Table Expression) est une table temporaire nommÃ©e dÃ©finie au dÃ©but dâ€™une requÃªte avec le mot-clÃ© **WITH**.

Ã€ quoi Ã§a sert ?

- Rendre une requÃªte plus lisible (au lieu dâ€™imbriquer des sous-requÃªtes)
- RÃ©utiliser un mÃªme sous-rÃ©sultat plusieurs fois
- Servir de base Ã  des requÃªtes rÃ©cursives
:::

Que fait cette requÃªte ?

```{.sql}
SELECT DISTINCT ON (code_pays) code_pays, 
       nom, 
       date_naissance
  FROM music.artiste
 WHERE NOT groupe
 ORDER BY code_pays, 
          date_naissance ASC;
```

Nous allons ici construire pas Ã  pas une requÃªte donnant le mÃªme rÃ©sultat en utilisant une CTE.

- [ ] Listez les artistes qui ne sont pas des groupes
- [ ] Affichez pour chaque pays, la plus ancienne date de naissance (celle du plus vieil artiste)

Nous souhaitons maintenant rÃ©cupÃ©rer le nom du plus viel artiste de chaque pays.

L'idÃ©e pour obtenir ce nom :

- stocker le rÃ©sultat de notre derniÃ¨re requÃªte dans une table temporaire *viel_artiste_pays*
- joindre cette table Ã  la table *artiste* via les colonnes *pays* et *date_naissance*

```{.sql}
WITH viel_artiste_pays AS (
...
)
SELECT ...
  FROM ...
  JOIN viel_artiste_pays pv ON ...
  ...
```

- [ ] En complÃ©tant la requÃªte Ã  trous ci-dessus, donnez pour chaque pays l'artiste le plus vieux

::: {.callout-tip title="Autre exemple"}
Pour vous aider, voici un autre exemple.

Si l'on veut les noms des artistes qui sont les seuls Ã  reprÃ©senter leur pays :

- nous commenÃ§ons par lister les pays avec un seul artiste
- nous joignons avec la table *artiste* pour rÃ©cupÃ©rer dans un second temps les noms

```{.sql}
WITH artiste_seul_dans_pays AS (
SELECT code_pays,
       COUNT(*) AS nb_artistes
  FROM artiste
 GROUP BY code_pays
HAVING COUNT(*) = 1
)
SELECT a.*
  FROM artiste a
  JOIN artiste_seul_dans_pays n ON a.code_pays = n.code_pays;
```
:::

::: {.callout-tip collapse="true" title="Solutions"}
- [Correction TP3](./correction/tp3.sql)
:::

## ArrÃªtez vos services {.unnumbered}

C'est la fin du TP, vous pouvez maintenant sauvegarder votre travail et libÃ©rer les ressources rÃ©servÃ©es :

- [ ] Copiez-collez vos scripts SQL sur votre machine
- [ ] ArrÃªter les services du Datalab
