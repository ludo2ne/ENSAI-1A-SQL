---
title: "Premi√®res requ√™tes SQL ü¶Ü"
description: "S√©lectionner, Filtrer, Agr√©ger"
author: "Ludovic Deneuville"
format: 
  html:
    toc: true
    toc-location: left
    toc-expand: 3
from: markdown+emoji
number-sections: true
number-depth: 3
---

## Introduction {.unnumbered}

Vous allez r√©aliser ce TP sur un Datalab.


### Datalab du GENES ou SSPCloud {.unnumbered}

Connectez-vous √† l'une des deux instances suivantes  :

- [ ] [Datalab SSPCloud de l'INSEE](https://datalab.sspcloud.fr/){target="_blank"} 
  - en cr√©ant un compte avec votre mail `prenom.nom@eleve.ensai.fr`
  - il est recommand√© d'utiliser en priorit√© le SSPCloud qui est plus stable
- [ ] [Datalab du GENES](https://onyxia.lab.groupe-genes.fr/){target="_blank"}


### VM ENSAI {.unnumbered}

::: {.callout-important title="En cas d'indisponibilit√© des Datalabs" collapse="true"}
Uniquement en cas d'indisponibilit√© des Datalabs, vous pouvez r√©aliser le TP directement sur la VM. Le logiciel DBeaver est install√©.

- [ ] Lancez DBeaver
- [ ] Onglet *Base de donn√©es* :arrow_right: *Nouvelle Connexion*
  - Type de connexion : `DuckDB`
  - Suivant
  - Path : `:memory:`
  - Terminer
- [ ] Dans l'explorer (√† gauche), clic droit sur la connexion que vous venez de cr√©er
  - *Editeur SQL* :arrow_right: *Script SQL* (raccourci : F3)

Cela ouvre une fen√™tre dans laquelle vous pouvez saisir du SQL.

:::

## Lancement du service

- [ ] Lancez le service [CloudBeaver](https://dbeaver.com/docs/cloudbeaver/){target="_blank"}
  - Allez dans **Catalogue de services**
  - Onglet **Databases**
- [ ] Ouvrez le service
  - Renseignez username et password

::: {.callout-tip title="CloudBeaver"}
CloudBeaver est une application web l√©g√®re d√©di√©e √† la gestion de bases de donn√©es. Elle permet de se connecter √† divers types de bases de donn√©es, qu'elles soient SQL, NoSQL ou h√©berg√©es dans le cloud, √† partir d'un seul point d'acc√®s via un navigateur. CloudBeaver facilite l'exploration, la modification et la visualisation des donn√©es sans n√©cessiter l'installation de logiciels locaux. 
:::

Pour ce premier TP, nous n'allons pas utiliser de base de donn√©es PostgreSQL. Nous allons simplement utiliser [DuckDB](https://duckdb.org/){target="_blank"} pour lire des fichiers de donn√©es.


::: {.callout-tip title="DuckDB"}
DuckDB est un moteur de base de donn√©es relationnelle con√ßu pour des analyses rapides et efficaces.

DuckDB est id√©al pour les charges de travail analytiques en raison de sa simplicit√©, de sa rapidit√© et de son extensibilit√©, surtout pour traiter des fichiers volumineux localement.

| **Caract√©ristique**   | **Description**                                                                                                                       |
|-----------------------|---------------------------------------------------------------------------------------------------------------------------------------|
| **Simplicit√©**        | Fonctionne sans serveur, int√©gr√© dans le processus h√¥te. Aucune d√©pendance externe pour la compilation ou l'ex√©cution, simplifiant son d√©ploiement. |
| **Rapidit√©**          | Optimis√© pour l'analytique (OLAP) avec un moteur d'ex√©cution vectoris√© en colonnes, r√©duisant le temps de traitement pour les requ√™tes complexes. |
| **Richesse fonctionnelle** | Supporte des requ√™tes SQL complexes, fonctions de fen√™tre, index secondaires, et assure des garanties ACID gr√¢ce au contr√¥le de concurrence (MVCC).|
| **Extensibilit√©**     | Permet l‚Äôajout de types de donn√©es, fonctions et formats de fichiers via des extensions (supporte Parquet, JSON, S3, HTTP(S)). |
| **Gratuit et open-source** | Licence MIT, code source disponible et contributions ouvertes √† tous. |
:::

Nous allons cr√©er une base de donn√©es stock√©e en m√©moire vive. L'avantage est que c'est tr√®s rapide. L'inconv√©nient, c'est que rien ne sera sauvegard√©.

- [ ] Cr√©ez une nouvelle connexion **DuckDB**
  - En haut √† gauche, cliquez sur le +, puis New connection
  - S√©lectionner **DuckDB**
  - Database : `:memory:`
  - Cliquez sur le bouton [CREATE]{.blue-button}
- [ ] Ouvrez un √©diteur SQL
  - Dans l'explorer √† gauche, clic droit sur votre connexion *DuckDB* :arrow_right: SQL Editor
  - vous pouvez maintenant saisir du code *SQL*


::: {.callout-caution}
Votre connexion doit √™tre ouverte (rond vert).

Si ce n'est pas le cas : clic droit > Open.

Puis r√©ouvrez une nouvelle fen√™tre SQL
:::



## Les pr√©noms

Le fichier des pr√©noms contient des donn√©es sur les pr√©noms attribu√©s aux enfants n√©s en France depuis 1900. Ces donn√©es sont disponibles au niveau France et par d√©partement.

Dans ce TP, nous allons utiliser la version au format [parquet](https://parquet.apache.org/){target="_blank"}.


::: {.callout-note title="Fichier parquet"}
Le format **Parquet** est un format de fichier de stockage de donn√©es optimis√© pour les syst√®mes de traitement analytique de grande √©chelle. Voici ses principales caract√©ristiques :

1. **Stockage en colonnes** : Parquet stocke les donn√©es par colonnes plut√¥t que par lignes, ce qui am√©liore l'efficacit√© de l'acc√®s aux donn√©es dans les charges de travail analytiques.
   
2. **Compression efficace** : La compression par colonne permet un taux de compression moyen de 5 √† 10 fois par rapport aux formats CSV, voire plus pour de gros fichiers. Cela r√©duit significativement la taille des donn√©es stock√©es et le co√ªt de stockage.

3. **Optimis√© pour l'analytique** : Parquet est con√ßu pour les requ√™tes en lecture intensive, car il permet de charger uniquement les colonnes n√©cessaires pour une analyse, ce qui am√©liore les performances en particulier sur les donn√©es volumineuses.

4. **M√©tadonn√©es Riches et Auto-descriptives** : Parquet inclut des m√©tadonn√©es d√©taill√©es (sch√©ma, types de donn√©es, statistiques min/max), permettant une lecture rapide et sans risque d'erreur. Ces m√©tadonn√©es facilitent √©galement le traitement des donn√©es par diff√©rents outils.

5. **Langage Ind√©pendant et Open Source** : Le format Parquet est ind√©pendant du langage et peut √™tre utilis√© avec divers langages de programmation (Python, R, C++, Java). Il est aussi open source et compatible avec la plupart des frameworks de big data.
:::

Pour en savoir plus sur le format Parquet : 

- [Parquet, qu'est-ce que c'est ?, Databricks](https://www.databricks.com/fr/glossary/what-is-parquet){target="_blank"}
- [What is the Parquet File Format?, Upsolver blog](https://www.upsolver.com/blog/apache-parquet-why-use){target="_blank"}


Pour des requ√™tes plus rapides, nous allons forcer le t√©l√©chargement en cache du fichier

- [ ] Ex√©cutez `SET force_download=true;`


Ici le fichier est relativement modeste (10 Mo), nous pouvons nous permettre de le stocker int√©gralement en m√©moire.

- [ ] Cr√©ez une table `prenoms` √† partir du contenu du fichier

```{.sql}
CREATE OR REPLACE TABLE prenoms AS
FROM 'https://www.insee.fr/fr/statistiques/fichier/8595130/prenoms-2024.parquet'
```

Vous pourrez ensuite requ√™ter sur cette vue comme si c'√©tait une table.

::: {.callout-tip title="√âx√©cuter une requ√™te"}
Cliquez sur la requ√™te pour y positionner le pointeur de la souris, puis au choix :

- Cliquez sur le petit triangle orange
- CTRL + ENTREE
:::




### Premi√®res requ√™tes


::: {.callout-important}

**Prenez le temps et l'habitude d'√©crire de jolies requ√™tes bien align√©es !!!**

```{.sql filename="bien.sql"}
SELECT c.nom AS club, 
       AVG(j.elo) AS moyenne_elo
  FROM joueuse j 
 INNER JOIN club c USING (id_club) 
 WHERE j.mail IS NOT NULL 
 GROUP BY c.nom 
 ORDER BY 2 DESC;
```

<br>

```{.sql filename="pasbien.sql"}
SELECT c.nom AS club, AVG(j.elo) AS moyenne_elo FROM joueuse j INNER JOIN club c USING (id_club) WHERE mail IS NOT NULL GROUP BY c.nom ORDER BY 2 DESC;
```

:::

- [ ] Listez tous les √©l√©ments de *prenoms*
- [ ] Filtrez pour n'afficher que le niveau g√©ographique *FRANCE* et le pr√©nom *GINETTE*

::: {.callout-tip title="Secret statistique"}
Vous remarquerez que les valeurs sont des multiples de 5.

> Pour chaque pr√©nom, il est indiqu√©, pour chaque ann√©e de naissance et chaque sexe, le nombre de personnes inscrites √† l‚Äô√©tat civil sous ce pr√©nom, arrondi au multiple de 5 le plus proche

Vous remarquerez √©galement que certaines ann√©es sont manquantes.

> Un pr√©nom est diffus√© s'il a √©t√© attribu√© au moins 3 fois √† des personnes de sexe f√©minin ou √† des personnes de sexe masculin

En statistique publique, on exige au moins 3 individus pour garantir le secret statistique. Avec 1 ou 2 personnes, on peut identifier ou d√©duire leurs donn√©es.
:::

Pour **la suite du TP**, nous allons uniquement nous interesser au niveau g√©ographique *FRANCE* :

- [ ] √Ä partir de la table *prenoms*, cr√©ez une table *prenoms_fr* conservant uniquement
  - les lignes o√π le niveau g√©ographique est √©gal √† *FRANCE*
  - les colonnes suivantes : *sexe*, *prenom*, *periode*, *valeur*
- [ ] Combien de lignes contient cette table ?



### Ann√©e 2022

> Filtrez sur l'ann√©e *2022*


- [ ] Listez les pr√©noms de l'ann√©e 2022
  - Classez-les en d√©croissant par le nombre de fois o√π ils ont √©t√© donn√©s
- [ ] Affichez uniquement les colonnes *sexe*, *prenom* et *valeur*
  - Affichez √©galement ces colonnes pour les questions suivantes
- [ ] Listez les pr√©noms de l'ann√©e 2022 donn√©s 2000 fois ou plus
- [ ] Classez-les d'abord par sexe, puis par nombre d√©croissant d'occurrences
  - Quels sont les pr√©noms masculins et f√©minins les plus donn√©s ?
- [ ] Listez les pr√©noms f√©minins commen√ßant par la lettre *Q*
- [ ] Listez les pr√©noms contenant exactement deux fois la lettre *V*
- [ ] Comptez le nombre de pr√©noms commen√ßant par chaque lettre

::: {.callout-tip}
Pour extraire la premi√®re lettre d'un pr√©nom, vous pouvez utiliser :

- la fonction [SUBSTRING](https://duckdb.org/docs/stable/sql/functions/text){target="_blank"}
- le slicing comme en R ou Python
:::
  
- [ ] Bonus : Comptez le nombre de pr√©noms commen√ßant par chaque lettre en diff√©renciant filles et gar√ßons


### Statistiques descriptives


- [ ] Lancez la commande `SUMMARIZE prenoms;` pour avoir quelques stats sur la table
- [ ] Affichez pour l'ann√©e 2003, les pr√©noms et leurs nombres de caract√®res
  - Trouvez une [fonction ad√©quate](https://duckdb.org/docs/stable/sql/functions/text){target="_blank"}
- [ ] Affichez le nombres de caract√®res minimum, maximum et moyen parmi les pr√©noms de 2003
- [ ] Listez les 3 pr√©noms de 2003 ayant le nombre de caract√®res maximum
  - Commencez par √©crire une requ√™te donnant le nombre de caract√®res maximum
  - Utilisez-l√† comme sous-requ√™te pour afficher les 3 pr√©noms
- [ ] Modifiez cette derni√®re requ√™te pour afficher pour chaque ann√©e entre 2015 et 2022 le ou les pr√©noms avec le plus de caract√®res
  - classez par ann√©e
  - Difficulty : :star: :star: :star:
- [ ] Affichez pour chaque ann√©e la taille moyenne des pr√©noms
  - classez par ann√©e
  - utilisez la fonction `ROUND(<value>, 2)` pour arrondir les moyennes
  - Que remarquez-vous ?


### J√©r√¥me, c'est moi


- [ ] Listez les diff√©rentes ann√©es o√π le pr√©nom `J√âR√îME` a √©t√© donn√©
  - Classez par ann√©e d√©croissante
  - Que remarquez-vous ?
- [ ] Quelles sont les diff√©rentes mani√®res d'√©crire ce pr√©nom (avec des accents diff√©rents) ?
- [ ] Listez √©galement les `JEROME` avec d'autres accents / sans accent
  - Recherchez une fonction DuckDB qui permet de r√©pondre √† ce besoin
- [ ] Affichez pour chaque ann√©e le nombre de fois o√π le pr√©nom JEROME a √©t√© donn√©, quelle que soit l'accentuation

::: {.callout-tip title="Aide" collapse="true"}
- voir Fonction DuckDB strip_accents()
- Regroupez par strip_accents(prenom) et periode
- Affichez strip_accents(prenom), periode et la somme de la colonne *valeur*
:::


### V√©rifions le classement

Avec cette histoire d'accents, posons-nous la question si cela peut modifier le classement des top pr√©noms.

- [ ] Affichez le top 10 des pr√©noms f√©minins en 2023 ?
- [ ] Quel pr√©nom se classe onzi√®me ?
  - Y-a-t-il d'autres orthographes proches pour √©crire ce pr√©nom ?
- [ ] Refaites le classement en ignorant les accents



### Pr√©noms compos√©s

Nous allons maintenant nous interesser aux pr√©noms compos√©s entre 2000 et 2009

- [ ] Listez les [diff√©rents]{.underline} pr√©noms compos√©s donn√©s entre les ann√©es 2000 et 2009 incluses
- [ ] Regroupez-les par *prenom*, puis affichez √©galement le nombre de fois o√π ils ont √©t√© donn√©s
  - Triez en d√©croissant par ce nombre
- [ ] Filtrez pour ne garder que les pr√©noms compos√©s contenant le pr√©nom `JEAN`
  - Que remarquez-vous ? N'y a-t-il pas des intrus ?
- [ ] Trouvez une solution pour rem√©dier √† ce souci


### Cette ann√©e-l√†

*Difficulty* : :star: :star: :star:

> Filtrez sur l'ann√©e 1962.


- [ ] Comptez le nombre de pr√©noms distincts donn√©s
- [ ] Compl√©tez en comptant le nombre de pr√©noms distincts donn√©s par sexe
- [ ] Compl√©tez en calculant le nombre total des pr√©noms distincts donn√©s, en prenant en compte la distinction entre les sexes
  - exemple : ici *Dominique (H)* et *Dominique (F)* comptent pour deux pr√©noms
- [ ] Donnez la liste des pr√©noms donn√©s √† la fois √† des filles et des gar√ßons
  - affichez le nombre de fois o√π ils ont √©t√© donn√©s √† chaque sexe
- [ ] Ajoutez √† la derni√®re requ√™te une colonne contenant un bool√©en qui affiche
  - True si le pr√©nom a √©t√© donn√© √† plus de filles que de gar√ßons
  - False sinon
- [ ] Au lieu d'afficher ce bool√©en, ajoutez une condition pour n'afficher que lorsque le pr√©nom a √©t√© plus donn√© √† des filles



## Fichier des individus

- [ ] Cr√©ez une vue qui pointe vers le fichier des individus du recensement de la population 2020

```{.sql}
CREATE OR REPLACE VIEW individus AS
FROM 'https://static.data.gouv.fr/resources/recensement-de-la-population-fichiers-detail-individus-localises-au-canton-ou-ville-2020-1/20231023-122841/fd-indcvi-2020.parquet';
```

- [ ] Comptez le nombre d'individus
  - Pourquoi ce nombre d'individus vivant en France para√Æt faible ?

::: {.callout-tip title="Poids de l'individu"}
Dans de nombreuses bases de donn√©es de l'INSEE, la variable `ipondi` repr√©sente le poids de l'individu.

i.e. Si une ligne a un IPONDI √©gal √† 2, cela signifie qu'elle repr√©sente 2 individus.
:::

- [ ] Au lieu de compter le nombre de lignes, sommez la variable `ipondi`
  - Vous pouvez suffixer votre somme par `::INT` pour convertir ce nombre en entier
- [ ] Affichez 10 lignes
  - Que remarquez-vous ?


::: {.callout-note title="Codification"}
Pourquoi utiliser une codification pour le fichier national individus localis√©s au canton-ou-ville du recensement de la population 2020 ?

- **Espace de stockage r√©duit** : Les codes courts remplacent des cha√Ænes de texte plus longues, ce qui diminue la taille du fichier et rend le stockage et le transfert de donn√©es plus efficaces. M√™me apr√®s codification, le fichier p√®se plus de 500 Mo
- **Standardisation et uniformit√©** : Utiliser des codes standardis√©s permet de garantir une structure homog√®ne et facilite l'int√©gration et la comparaison des donn√©es entre diff√©rents fichiers ou √©tudes.
- **Performances de traitement** : Les codes sont plus rapides √† traiter que des textes longs, notamment pour des op√©rations de recherche, de tri, et de filtrage, ce qui est crucial pour les grands ensembles de donn√©es.
:::

- [ ] Pour s'y retrouver, cr√©ez une vue vers le dictionnaire des variables

```{.sql}
CREATE OR REPLACE VIEW variables_individus AS
FROM 'https://static.data.gouv.fr/resources/recensement-de-la-population-fichiers-detail-individus-localises-au-canton-ou-ville-2020-1/20231025-082910/dictionnaire-variables-indcvi-2020.csv'
```

- [ ] Affichez tout le contenu de cette vue
- [ ] Trouvez la modalit√© repr√©sentant le d√©partement de r√©sidence de l'individu
- [ ] Affichez le nombre d'habitants par d√©partements
  - ordonnez par num√©ro de d√©partement
- [ ] Compl√©tez la requ√™te en :
  - restreignant sur les individus entre 25 et 29 ans
  -  diff√©renciant les hommes et les femmes

::: {.callout-tip collapse="true" title="Solutions"}
- [Correction TP1](./doc/tp/correction/tp1.sql)
:::

## Arr√™tez votre service {.unnumbered}

C'est la fin du TP, vous pouvez maintenant sauvegarder votre travail et lib√©rer les ressources r√©serv√©es :

- [ ] Copiez votre code et collez le sur votre machine dans un fichier *.sql*
  - par exemple dans `P:/Cours1A/UE3-Bases-de-donnees-relationnelles/TP1/tp1.sql`
- [ ] Retournez sur la page d'accueil du Datalab
- [ ] Allez dans *Mes Services* et supprimez votre service

## Pour aller plus loin {.unnumbered}

- [3 explorations bluffantes avec DuckDB](https://www.icem7.fr/pedagogie/3-explorations-bluffantes-avec-duckdb-1-interroger-des-fichiers-distants/){target="_blank"}
- [Avec DuckDB, gavez-vous d'open data!](https://www.youtube.com/watch?v=ajo0VBXT6ho){target="_blank"}
- [DuckDB, un aper√ßu du futur !](https://www.youtube.com/watch?v=7nklk064IR8){target="_blank"}
